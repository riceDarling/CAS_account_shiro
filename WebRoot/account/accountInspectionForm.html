<link href="bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<script src="bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="bootstrap-datetimepicker/js/bootstrap-datetimepicker.zh-CN.js"></script>
<div class="col-md-12">
	<div class="panel panel-cascade">
		<div class="panel-heading">
			<h3 class="panel-title">
				<i class="fa fa-pencil-square"></i><a href_1="accountInspectionList.html">送检单列表</a> <i class="fa fa-pencil-square"></i>送检单添加
			</h3>
		</div>
	</div>
</div>
<h4 style="text-align:center;">
	<span id="title"></span>待送检列表
</h4>
<div class="col-md-12">
	<div class="panel">
		<div class="panel-body">
			<table class="table table-bordered table-condensed table-hover" id="contentTable2">
				<thead>
					<tr>
						<th></th>
						<th>合同名称</th>
						<th>到货日期</th>
					</tr>
				</thead>
				<tbody id="secondPageTbody">
				</tbody>
			</table>
		</div>
		<ul class="nav nav-tabs">
			<li class="active"><a href="">送检信息</a></li>
		</ul>
		<div class="panel-body">
			<input name="ordernum" hidden="true" id="ordernum" htmlEscape="false" maxlength="64" class="input-xlarge required" />
			<div class="control-group">
				<label class="col-lg-3 col-md-3 control-label">送检日期：</label>
				<div class="col-lg-9 col-md-9">
					<input size="16" type="text" readonly class="form_datetime form-control" name="inspectiondate">
				</div>
			</div>
			<div class="control-group">
				<label class="col-lg-3 col-md-3 control-label">检验状态：</label>
				<div class="col-lg-9 col-md-9">
					<select id="status" htmlEscape="false" maxlength="35" class="input-xlarge required form-control ">
						<option value="">请选择</option>
						<option value="1">不合格</option>
						<option value="2">合格</option>
						<option value="3">免检</option>
					</select>
				</div>
			</div>
			<div class="control-group">
				<label class="col-lg-3 col-md-3 control-label">检验方式：</label>
				<div class="col-lg-9 col-md-9">
					<select class="inspectionmode form-control" name="inspectionmode" htmlEscape="false" maxlength="35">
					</select> <span class="help-inline">
				</div>
			</div>
			<div class="control-group">
				<label class="col-lg-3 col-md-3 control-label">备注信息：</label>
				<div class="col-lg-9 col-md-9">
					<textarea name="remarks" htmlEscape="false" class="form-control" />
				</div>
			</div>
			<div class="control-group">
				<label class="col-lg-3 col-md-3 control-label">送检单子表：</label>
				<div class="col-lg-9 col-md-9">
					<table  class="table table-striped table-bordered table-condensed">
						<thead>
							<tr>
								<th>物资名称</th>
								<th>规格型号</th>
								<th>成分含量</th>
								<th>粒度</th>
								<th>外观</th>
								<th>备注</th>
						</thead>
						<tbody id="accountInspectionDetailList">
						</tbody>
					</table>
				</div>
			</div>
			<div class="control-group">
				<input id="saveInspection" class="btn btn-primary" type="button" value="保 存" />
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
		$("[href_1]").click(function() {
			$("#index_content").load($(this).attr("href_1"));
		});
		$(".form_datetime").datetimepicker({
			language : 'zh-CN',
			minView : "month", //选择日期后，不会再跳转去选择时分秒 
			format : 'yyyy-mm-dd',
			todayBtn : 1,
			autoclose : 1,
		});
		$(function(){
			var ordernum = "30-";
			var date = new Date();
			var year = date.getFullYear();
			var month =date.getMonth() + 1;
			var day = date.getDate();
			if (month < 10) {
				month = "0" + month;
			}
			if (day < 10) {
				day = "0" + day;
			}
			ordernum = ordernum + year + month + day + "-";
			var ordernumRandom = "";
			for (var i = 0; i < 5; ++i) {
				var num = Math.random();
				num = parseInt(num*10);
				ordernumRandom += num;
			}
			ordernum += ordernumRandom;
			$("#ordernum").val(ordernum);
			$.ajax({
				url : "http://" + IP_config + "/account/accountInspectionController/formSec",
				type : "post",
				success : function(data) {
					for ( var index in data.obj) {
						var content = "<tr>"
						content += "<td><input onepluschecked type='radio'  name='idxk' value='"+data.obj[index].arrivalId+"' ></td> "
						content += "<td>" + data.obj[index].contractTitle + "</td>"
						content += "<td>" + data.obj[index].arrivalDate + "</td>"
						content += "</tr>"
						$("#secondPageTbody").html(content)
					}
				}
		});
			//计量单位
			$.ajax({
				url:"http://"+IP_config+"/account/paraInfo/getParaInfoList",
				dataType: "json",
				xhrFields: {
					withCredentials: true
				},
				data:{
					"pId":7
				},
				type: "POST",
				success: function(data) {
					if(data.success){
						//获取成功
						var html="<option value=''>请选择</option>";
						for (i in data.obj) {
							html+="<option value='"+data.obj[i].id +"'>"+data.obj[i].name +"</option>";
						}
						$(".inspectionmode").html(html);
					}else{
						//获取失败提示
						layer.alert(data.msg);
					}
				}
			});

});
		//选择合同获取详细数据
		$(document).on("click","[name='idxk']",function(){
			var id=$("#contentTable2 input[name='idxk']:checked ").val();
			$.ajax({
				url : "http://" + IP_config + "/account/accountArrivalController/lastForm",
				type : 'post',
				dataType : 'json',
				data : {
					"id" : id
				},
				success : function(data) {
					$.cookie("accountArrivalList_id", null);
					if (data.success) {
						for ( var index in data.obj) {
							var content = "<tr>"
							content += "<td>" + data.obj[index].materialName + "</td>"
							content += "<td>" + data.obj[index].size + "</td>"
						    content += "<td><input type='text'></input></td>"
							content += "<td><input type='text'></input></td>"
							content += "<td><input type='text'></input></td>"
							content += "<td><input type='text'></input></td>"
							content += "</tr>"
							$("#accountInspectionDetailList").html(content)
						}
					} else {
						layer.alert(data.msg);
					}
				}
			})
		})
		$("#saveInspection").click(function(){
			if($("[onepluschecked]:checked").length<=0){
				alert("请选中与送检单相关的待送检数据!");
			}else{
				$("#saveInspection").attr("disabled", true); 
				var accountInspection = {};
				accountInspection.ordernum = $("#ordernum").val();
				accountInspection.arrivalnum = $("#contentTable2 input[name='idxk']:checked ").val();
				accountInspection.inspectiondate = $("[name='inspectiondate']").val();
				accountInspection.remarks = $("[name='remarks']").val();
				var len = $("#accountInspectionDetailList tr").length;
				var aiArr = new Array();
				for(var i = 0;i < len;i++){
					var aiDetail = {};
					var materialname = $("#accountInspectionDetailList tr:eq("+i+") td:eq(0)").text();
					var size = $("#accountInspectionDetailList tr:eq("+i+") td:eq(1)").text();
					var ingredient = $("#accountInspectionDetailList tr:eq("+i+") td:eq(2) input").val();
					var granularity = $("#accountInspectionDetailList tr:eq("+i+") td:eq(3) input").val();
					var appearance = $("#accountInspectionDetailList tr:eq("+i+") td:eq(4) input").val();
					var remarks = $("#accountInspectionDetailList tr:eq("+i+") td:eq(5) input").val();
					aiDetail.materialname = materialname;
					aiDetail.size = size;
					aiDetail.ingredient = ingredient;
					aiDetail.granularity = granularity;
					aiDetail.appearance = appearance;
					aiDetail.remarks = remarks;
					aiDetail.status = $("#status option:selected").val();
					aiDetail.inspectionmode = $("[name='inspectionmode'] option:selected").val();
					aiArr.push(aiDetail);
				}
				accountInspection.accountInspectionDetail = aiArr;
				
					$.ajax({
						url:"http://" + IP_config + "/account/accountInspectionController/save",
						type:"post",
						contentType:"application/json;charset=UTF-8",
						data:JSON.stringify(accountInspection), 
						async:false
					}); 
					if(aiArr!=null&&aiArr!=""){
						layer.alert("送检成功");
						$("#index_content").load("accountInspectionList.html");
					}
					else{
						layer.alert("送检失败");
						$("#index_content").load("accountInspectionForm.html");
					}
			} 
		
		});  
	</script>
